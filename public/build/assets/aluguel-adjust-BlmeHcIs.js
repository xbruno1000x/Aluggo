import{M as h}from"./bootstrap.esm-D_BmgoUQ.js";import{s as B}from"./alert-DLWxqPIg.js";document.addEventListener("DOMContentLoaded",()=>{var S;const w=document.getElementById("adjustRentModal"),x=document.getElementById("adjustRentForm"),l=document.getElementById("adjustModeManual"),C=document.getElementById("adjustModeIgpm"),M=document.getElementById("adjustManualGroup"),L=document.getElementById("adjustIgpmGroup"),f=document.getElementById("adjustManualValue"),N=document.getElementById("adjustCurrentValue"),P=document.getElementById("adjustContractInfo"),r=document.getElementById("igpmPreviewBtn"),i=document.getElementById("igpmPreviewResult"),I=document.getElementById("igpmPeriodText"),v=document.getElementById("adjustErrors"),p=document.getElementById("adjustSubmitBtn");if(!w||!x||!l||!C)return;let y="";const $=()=>h.getOrCreateInstance&&h.getOrCreateInstance(w)||h.getInstance&&h.getInstance(w)||new h(w),b=((S=document.querySelector('meta[name="csrf-token"]'))==null?void 0:S.content)??"";function c(e){if(v){if(!e){v.textContent="",v.classList.add("d-none");return}v.textContent=e,v.classList.remove("d-none")}}function k(e){let t=(e||"").trim();return t===""?"":(t=t.replace(/\.(?=\d{3}(?:[^\d]|$))/g,""),t=t.replace(",","."),t)}function A(e){return e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return t}})}function j(){const e=(l==null?void 0:l.checked)??!1;M&&M.classList.toggle("d-none",!e),L&&L.classList.toggle("d-none",e),r&&(r.disabled=e),e&&i&&(i.textContent=""),c()}l.addEventListener("change",j),C.addEventListener("change",j),document.querySelectorAll(".open-adjust-btn").forEach(e=>{e.addEventListener("click",()=>{y=e.dataset.action??"";const t=e.dataset.valor??"",a=t?parseFloat(t):NaN;f&&(Number.isNaN(a)?f.value="":f.value=a.toFixed(2).replace(".",","));const n=e.dataset.imovel??"",o=e.dataset.imovelNumero??"",u=e.dataset.propriedade??"",d=e.dataset.locatario??"",g=e.dataset.dataInicioBr??"-",s=e.dataset.dataFimBr??"-",E=e.dataset.valorFormatado??"Valor não informado";if(N&&(N.textContent=E),P){const m=[];n&&m.push(o?`${n} (nº ${o})`:n),u&&m.push(`Propriedade: ${u}`),d&&m.push(`Locatário: ${d}`),m.push(`Vigência: ${g} — ${s}`),P.innerHTML=m.map(T=>`<p class="mb-0 small text-muted">${A(T)}</p>`).join("")}I&&(I.textContent="Selecione o modo IGP-M para calcular automaticamente."),i&&(i.textContent=""),c(),l.checked=!0,C.checked=!1,j();try{$().show()}catch(m){console.warn("[aluguel-adjust] falha ao abrir modal",m)}})});async function F(e){if(!y)throw new Error("Ação do formulário não configurada.");return await fetch(y,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-CSRF-TOKEN":b},body:e.toString()})}r==null||r.addEventListener("click",async()=>{if(c(),!y){B("error","Selecione um contrato antes de simular.");return}const e=new URLSearchParams;e.set("_method","PATCH"),e.set("mode","igpm"),e.set("preview","1"),r&&(r.disabled=!0,r.textContent="Calculando..."),i&&(i.textContent="");try{const t=await F(e);if(!t.ok){let n="Não foi possível calcular o IGP-M.";try{const o=await t.json();o&&o.message&&(n=o.message)}catch{}c(n);return}const a=await t.json();if(i){const n=typeof a.igpm_percent=="number"?`${a.igpm_percent.toFixed(2)}%`:"N/D";i.textContent=`Novo valor estimado: ${a.new_value_formatted||""} (IGP-M acumulado: ${n})`}I&&a.period&&(I.textContent=`Período considerado: ${a.period.start_br??""} — ${a.period.end_br??""}`)}catch(t){console.error("[aluguel-adjust] preview error",t),c("Erro ao comunicar com o servidor.")}finally{r&&(r.disabled=!1,r.textContent="Simular novo valor")}}),x.addEventListener("submit",async e=>{var n;if(e.preventDefault(),c(),!y){B("error","Selecione um contrato para reajustar.");return}const t=l.checked?"manual":"igpm",a=new URLSearchParams;if(a.set("_method","PATCH"),a.set("mode",t),t==="manual"){const o=(f==null?void 0:f.value)??"",u=k(o);if(!u){c("Informe o novo valor do aluguel.");return}const d=parseFloat(u);if(!Number.isFinite(d)||d<0){c("Valor inválido. Use apenas números e vírgula para centavos.");return}a.set("novo_valor",d.toFixed(2))}try{p&&(p.disabled=!0,p.textContent="Aplicando...");const o=await F(a);if(!o.ok){let g="Não foi possível aplicar o reajuste.";try{const s=await o.json();if(s&&s.message&&(g=s.message),s&&s.errors){const E=Object.keys(s.errors)[0];E&&((n=s.errors[E])!=null&&n.length)&&(g=s.errors[E][0])}}catch{}c(g);return}const u=await o.json();try{$().hide()}catch{}const d=u.message||"Aluguel reajustado com sucesso.";B("success",d,1800),setTimeout(()=>window.location.reload(),900)}catch(o){console.error("[aluguel-adjust] submit error",o),c("Erro ao comunicar com o servidor.")}finally{p&&(p.disabled=!1,p.textContent="Aplicar reajuste")}}),j()});
